name: validate

on:
  workflow_dispatch: # manual trigger only
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: lint files
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: chronos_app
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version-file: chronos_app/.nvmrc
          cache: pnpm
          cache-dependency-path: chronos_app/pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  test-components:
    name: test components package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: chronos_app
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version-file: chronos_app/.nvmrc
          cache: pnpm
          cache-dependency-path: chronos_app/pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile
      - name: Run tests with coverage
        run: pnpm test:components -- --coverage

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-components
          path: chronos_app/packages/components/coverage/coverage-summary.json
          retention-days: 1

  test-server:
    name: test server package
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: chronos_app
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version-file: chronos_app/.nvmrc
          cache: pnpm
          cache-dependency-path: chronos_app/pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - name: Run tests with coverage
        run: pnpm test:server -- --coverage

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-server
          path: chronos_app/packages/server/coverage/coverage-summary.json
          retention-days: 1

  coverage-report:
    name: post coverage report
    runs-on: ubuntu-latest
    needs: [test-components, test-server]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Download components coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-components
          path: coverage/components

      - name: Download server coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-server
          path: coverage/server

      - name: Generate coverage comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            /**
             * Reads and parses coverage summary JSON file
             * @param {string} path - Path to coverage-summary.json
             * @returns {object|null} Parsed coverage data or null if not found
             */
            function readCoverage(path) {
              try {
                const data = JSON.parse(fs.readFileSync(path, 'utf8'));
                return data.total;
              } catch (e) {
                console.log(`Could not read ${path}: ${e.message}`);
                return null;
              }
            }

            /**
             * Formats a percentage value with color indicator
             * @param {number} pct - Percentage value
             * @returns {string} Formatted percentage string
             */
            function formatPct(pct) {
              const value = pct.toFixed(2);
              if (pct >= 80) return `ğŸŸ¢ ${value}%`;
              if (pct >= 50) return `ğŸŸ¡ ${value}%`;
              return `ğŸ”´ ${value}%`;
            }

            const componentsCov = readCoverage('coverage/components/coverage-summary.json');
            const serverCov = readCoverage('coverage/server/coverage-summary.json');

            let body = '## ğŸ“Š Test Coverage Report\n\n';
            body += '| Package | Statements | Branches | Functions | Lines |\n';
            body += '|---------|------------|----------|-----------|-------|\n';

            if (serverCov) {
              body += `| **server** | ${formatPct(serverCov.statements.pct)} | ${formatPct(serverCov.branches.pct)} | ${formatPct(serverCov.functions.pct)} | ${formatPct(serverCov.lines.pct)} |\n`;
            } else {
              body += '| **server** | âš ï¸ No data | âš ï¸ No data | âš ï¸ No data | âš ï¸ No data |\n';
            }

            if (componentsCov) {
              body += `| **components** | ${formatPct(componentsCov.statements.pct)} | ${formatPct(componentsCov.branches.pct)} | ${formatPct(componentsCov.functions.pct)} | ${formatPct(componentsCov.lines.pct)} |\n`;
            } else {
              body += '| **components** | âš ï¸ No data | âš ï¸ No data | âš ï¸ No data | âš ï¸ No data |\n';
            }

            body += '\n<details>\n<summary>Coverage thresholds</summary>\n\n';
            body += '- ğŸŸ¢ Good: â‰¥80%\n';
            body += '- ğŸŸ¡ Acceptable: â‰¥50%\n';
            body += '- ğŸ”´ Needs improvement: <50%\n';
            body += '</details>\n\n';
            body += '*Updated on each push â€¢ Generated by CI*';

            // Find existing coverage comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ“Š Test Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
              console.log('Updated existing coverage comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
              console.log('Created new coverage comment');
            }
